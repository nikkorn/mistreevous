"use strict";var mistreevous=(()=>{var Ct=Object.create;var X=Object.defineProperty;var It=Object.getOwnPropertyDescriptor;var $t=Object.getOwnPropertyNames;var Ut=Object.getPrototypeOf,Ft=Object.prototype.hasOwnProperty;var $=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Tt=(t,e)=>{for(var r in e)X(t,r,{get:e[r],enumerable:!0})},mt=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of $t(e))!Ft.call(t,i)&&i!==r&&X(t,i,{get:()=>e[i],enumerable:!(o=It(e,i))||o.enumerable});return t};var Lt=(t,e,r)=>(r=t!=null?Ct(Ut(t)):{},mt(e||!t||!t.__esModule?X(r,"default",{value:t,enumerable:!0}):r,t)),Ot=t=>mt(X({},"__esModule",{value:!0}),t);var Et=$(at=>{"use strict";Object.defineProperty(at,"__esModule",{value:!0});at.Participant=void 0;var Ne=function(){function t(e,r){r===void 0&&(r=1),this._participant=e,this._tickets=r}return Object.defineProperty(t.prototype,"participant",{get:function(){return this._participant},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tickets",{get:function(){return this._tickets},set:function(e){this._tickets=e},enumerable:!1,configurable:!0}),t}();at.Participant=Ne});var Dt=$(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.isNaturalNumber=I.isNullOrUndefined=void 0;function we(t){return t==null}I.isNullOrUndefined=we;function Ae(t){return typeof t=="number"&&t>=1&&Math.floor(t)===t}I.isNaturalNumber=Ae});var vt=$(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});st.Lotto=void 0;var Ee=Et(),G=Dt(),De=function(){function t(e){this._participants=[],this._customRandom=e}return t.prototype.add=function(e,r){if(r===void 0&&(r=1),!(0,G.isNaturalNumber)(r))throw new Error("tickets value must be a natural number");var o=this._participants.find(function(i){return i.participant===e});return o?o.tickets+=r:this._participants.push(new Ee.Participant(e,r)),this},t.prototype.remove=function(e,r){var o=this._participants.find(function(i){return i.participant===e});if(!o)return this;if(r!==void 0){if(!(0,G.isNaturalNumber)(r))throw new Error("tickets value must be a natural number");o.tickets-=r,o.tickets<1&&(this._participants=this._participants.filter(function(i){return i!==o}))}else this._participants=this._participants.filter(function(i){return i!==o});return this},t.prototype.draw=function(e){if(e===void 0&&(e={}),this._participants.length===0)return null;var r=(0,G.isNullOrUndefined)(e.redrawable)?!0:e.redrawable,o=[];this._participants.forEach(function(a){for(var s=a.participant,c=a.tickets,ht=0;ht<c;ht++)o.push(s)});var i;if(this._customRandom){if(i=this._customRandom(),typeof i!="number"||i<0||i>=1)throw new Error("the 'random' function provided did not return a number between 0 (inclusive) and 1")}else i=Math.random();var n=o[Math.floor(i*o.length)];return r||this.remove(n,1),n},t.prototype.drawMultiple=function(e,r){r===void 0&&(r={});var o=(0,G.isNullOrUndefined)(r.unique)?!1:r.unique;if(e===0)return[];if(!(0,G.isNaturalNumber)(e))throw new Error("tickets value must be a natural number");for(var i=[];i.length<e&&this._participants.length>0;)i.push(this.draw(r));if(o){for(var n=[],a=0,s=i;a<s.length;a++){var c=s[a];n.indexOf(c)===-1&&n.push(c)}i=n}return i},t}();st.Lotto=De});var St=$(ut=>{"use strict";Object.defineProperty(ut,"__esModule",{value:!0});ut.createLotto=void 0;var dt=vt();function ve(t){if(!t)return new dt.Lotto;if(Array.isArray(t)){var e=t,r=new dt.Lotto;return e.forEach(function(n){var a=n[0],s=n[1];return r.add(a,s)}),r}else{var o=t.random,e=t.participants,i=new dt.Lotto(o);return e&&e.forEach(function(a){var s=a[0],c=a[1];return i.add(s,c)}),i}}ut.createLotto=ve});var xt=$(lt=>{"use strict";Object.defineProperty(lt,"__esModule",{value:!0});var Se=St();lt.default=Se.createLotto});var Ie={};Tt(Ie,{BehaviourTree:()=>ct,State:()=>d,convertMDSLToJSON:()=>C,validateDefinition:()=>ot});var d=(i=>(i.READY="mistreevous.ready",i.RUNNING="mistreevous.running",i.SUCCEEDED="mistreevous.succeeded",i.FAILED="mistreevous.failed",i))(d||{});var u=class{static registeredFunctions={};static registeredSubtrees={};static getFunc(e){return this.registeredFunctions[e]}static setFunc(e,r){this.registeredFunctions[e]=r}static getFuncInvoker(e,r){let o=n=>n.map(a=>{if(typeof a=="object"&&a!==null&&Object.keys(a).length===1&&Object.prototype.hasOwnProperty.call(a,"$")){let s=a.$;if(typeof s!="string"||s.length===0)throw new Error("Agent property reference must be a string?");return e[s]}return a}),i=e[r];if(i&&typeof i=="function")return n=>i.apply(e,o(n));if(this.registeredFunctions[r]&&typeof this.registeredFunctions[r]=="function"){let n=this.registeredFunctions[r];return a=>n(e,...o(a))}return null}static getSubtrees(){return this.registeredSubtrees}static setSubtree(e,r){this.registeredSubtrees[e]=r}static remove(e){delete this.registeredFunctions[e],delete this.registeredSubtrees[e]}static empty(){this.registeredFunctions={},this.registeredSubtrees={}}};function gt(t){return t.type==="root"}function yt(t){return t.type==="branch"}function bt(t){return["branch","action","condition","wait"].includes(t.type)}function tt(t){return["root","repeat","retry","flip","succeed","fail"].includes(t.type)}function et(t){return["sequence","selector","lotto","parallel","race","all"].includes(t.type)}function Nt(t){let e=[],r=o=>{e.push(o),et(o)?o.children.forEach(r):tt(o)&&r(o.child)};return r(t),e}function b(t){return typeof t=="number"&&Math.floor(t)===t}function rt(t){return typeof t>"u"||t===null}function R(t){return t.type==="property_reference"?{$:t.value}:t.value}function l(t,e){let r=t.shift();if(r===void 0)throw new Error("unexpected end of definition");if(e!=null){let o=typeof e=="string"?[e]:e;if(!o.some(n=>r.toUpperCase()===n.toUpperCase())){let n=o.map(a=>"'"+a+"'").join(" or ");throw new Error("unexpected token found. Expected "+n+" but got '"+r+"'")}}return r}function wt(t){t=t.replace(/\/\*(.|\n)*?\*\//g,"");let{placeholders:e,processedDefinition:r}=Pt(t);return t=r.replace(/\(/g," ( "),t=t.replace(/\)/g," ) "),t=t.replace(/\{/g," { "),t=t.replace(/\}/g," } "),t=t.replace(/\]/g," ] "),t=t.replace(/\[/g," [ "),t=t.replace(/,/g," , "),{tokens:t.replace(/\s+/g," ").trim().split(" "),placeholders:e}}function Pt(t){let e={},r=t.replace(/"(\\.|[^"\\])*"/g,o=>{let i=o.substring(1,o.length-1),n=Object.keys(e).find(a=>e[a]===i);return n||(n=`@@${Object.keys(e).length}@@`,e[n]=i),n});return{placeholders:e,processedDefinition:r}}function N(t,e){let r=[];if(!["[","("].includes(t[0]))return r;let o=l(t,["[","("])==="["?"]":")",i=[];for(;t.length&&t[0]!==o;)i.push(t.shift());return i.forEach((n,a)=>{if(!(a&1)){let c=Gt(n,e);r.push(c)}else if(n!==",")throw new Error(`invalid argument list, expected ',' or ']' but got '${n}'`)}),l(t,o),r}function Gt(t,e){return t==="null"?{value:null,type:"null"}:t==="true"||t==="false"?{value:t==="true",type:"boolean"}:isNaN(t)?t.match(/^@@\d+@@$/g)?{value:e[t].replace('\\"','"'),type:"string"}:t.match(/^\$[_a-zA-Z][_a-zA-Z0-9]*/g)?{value:t.slice(1),type:"property_reference"}:{value:t,type:"identifier"}:{value:parseFloat(t),isInteger:parseFloat(t)===parseInt(t,10),type:"number"}}function p(t,e){let r=["while","until","entry","exit","step"],o={},i=t[0]?.toLowerCase();for(;r.includes(i);){if(o[i])throw new Error(`duplicate attribute '${t[0].toUpperCase()}' found for node`);t.shift();let[n,...a]=N(t,e);if(n?.type!=="identifier")throw new Error("expected agent function or registered function name identifier argument for attribute");if(a.filter(s=>s.type==="identifier").forEach(s=>{throw new Error(`invalid attribute argument value '${s.value}', must be string, number, boolean, null or agent property reference`)}),i==="while"||i==="until"){let s=!1;t[0]?.toLowerCase()==="then"&&(t.shift(),s=l(t,["succeed","fail"]).toLowerCase()==="succeed"),o[i]={call:n.value,args:a.map(R),succeedOnAbort:s}}else o[i]={call:n.value,args:a.map(R)};i=t[0]?.toLowerCase()}return o}function C(t){let{tokens:e,placeholders:r}=wt(t);return kt(e,r)}function kt(t,e){if(t.length<3)throw new Error("invalid token count");if(t.filter(a=>a==="{").length!==t.filter(a=>a==="}").length)throw new Error("scope character mismatch");let r=[],o=[],i=a=>{if(gt(a)){if(r[r.length-1]?.length)throw new Error("a root node cannot be the child of another node");o.push(a),r.push([a]);return}if(!r.length||!r[r.length-1].length)throw new Error("expected root node at base of definition");let s=r[r.length-1],c=s[s.length-1];if(et(c))c.children=c.children||[],c.children.push(a);else if(tt(c)){if(c.child)throw new Error("a decorator node must only have a single child node");c.child=a}bt(a)||s.push(a)},n=()=>{let a=null,s=r[r.length-1];return s.length&&(a=s.pop()),s.length||r.pop(),a};for(;t.length;){let a=t.shift();switch(a.toUpperCase()){case"ROOT":{i(Mt(t,e));break}case"SUCCEED":{i(Bt(t,e));break}case"FAIL":{i(_t(t,e));break}case"FLIP":{i(jt(t,e));break}case"REPEAT":{i(Yt(t,e));break}case"RETRY":{i(qt(t,e));break}case"SEQUENCE":{i(Wt(t,e));break}case"SELECTOR":{i(Jt(t,e));break}case"PARALLEL":{i(Vt(t,e));break}case"RACE":{i(zt(t,e));break}case"ALL":{i(Qt(t,e));break}case"LOTTO":{i(Zt(t,e));break}case"ACTION":{i(Ht(t,e));break}case"CONDITION":{i(Kt(t,e));break}case"WAIT":{i(Xt(t,e));break}case"BRANCH":{i(te(t,e));break}case"}":{let s=n();s&&ee(s);break}default:throw new Error(`unexpected token: ${a}`)}}return o}function Mt(t,e){let r={type:"root"},o=N(t,e);if(o.length)if(o.length===1&&o[0].type==="identifier")r.id=o[0].value;else throw new Error("expected single root name argument");return r={...r,...p(t,e)},l(t,"{"),r}function Bt(t,e){let r={type:"succeed",...p(t,e)};return l(t,"{"),r}function _t(t,e){let r={type:"fail",...p(t,e)};return l(t,"{"),r}function jt(t,e){let r={type:"flip",...p(t,e)};return l(t,"{"),r}function Yt(t,e){let r={type:"repeat"},o=N(t,e);if(o.length)if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("repeat node iteration counts must be integer values")}),o.length===1){if(r.iterations=o[0].value,r.iterations<0)throw new Error("a repeat node must have a positive number of iterations if defined")}else if(o.length===2){if(r.iterations=[o[0].value,o[1].value],r.iterations[0]<0||r.iterations[1]<0)throw new Error("a repeat node must have a positive minimum and maximum iteration count if defined");if(r.iterations[0]>r.iterations[1])throw new Error("a repeat node must not have a minimum iteration count that exceeds the maximum iteration count")}else throw new Error("invalid number of repeat node iteration count arguments defined");return r={...r,...p(t,e)},l(t,"{"),r}function qt(t,e){let r={type:"retry"},o=N(t,e);if(o.length)if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("retry node attempt counts must be integer values")}),o.length===1){if(r.attempts=o[0].value,r.attempts<0)throw new Error("a retry node must have a positive number of attempts if defined")}else if(o.length===2){if(r.attempts=[o[0].value,o[1].value],r.attempts[0]<0||r.attempts[1]<0)throw new Error("a retry node must have a positive minimum and maximum attempt count if defined");if(r.attempts[0]>r.attempts[1])throw new Error("a retry node must not have a minimum attempt count that exceeds the maximum attempt count")}else throw new Error("invalid number of retry node attempt count arguments defined");return r={...r,...p(t,e)},l(t,"{"),r}function Wt(t,e){let r={type:"sequence",...p(t,e)};return l(t,"{"),r}function Jt(t,e){let r={type:"selector",...p(t,e)};return l(t,"{"),r}function Vt(t,e){let r={type:"parallel",...p(t,e)};return l(t,"{"),r}function zt(t,e){let r={type:"race",...p(t,e)};return l(t,"{"),r}function Qt(t,e){let r={type:"all",...p(t,e)};return l(t,"{"),r}function Zt(t,e){let r=N(t,e);r.filter(i=>i.type!=="number"||!i.isInteger||i.value<0).forEach(()=>{throw new Error("lotto node weight arguments must be positive integer values")});let o={type:"lotto",...p(t,e)};return r.length&&(o.weights=r.map(({value:i})=>i)),l(t,"{"),o}function Ht(t,e){let[r,...o]=N(t,e);if(r?.type!=="identifier")throw new Error("expected action name identifier argument");return{type:"action",call:r.value,args:o.map(R),...p(t,e)}}function Kt(t,e){let[r,...o]=N(t,e);if(r?.type!=="identifier")throw new Error("expected condition name identifier argument");return{type:"condition",call:r.value,args:o.map(R),...p(t,e)}}function Xt(t,e){let r={type:"wait"},o=N(t,e);if(o.length){if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("wait node durations must be integer values")}),o.length===1){if(r.duration=o[0].value,r.duration<0)throw new Error("a wait node must have a positive duration")}else if(o.length===2){if(r.duration=[o[0].value,o[1].value],r.duration[0]<0||r.duration[1]<0)throw new Error("a wait node must have a positive minimum and maximum duration");if(r.duration[0]>r.duration[1])throw new Error("a wait node must not have a minimum duration that exceeds the maximum duration")}else if(o.length>2)throw new Error("invalid number of wait node duration arguments defined")}return{...r,...p(t,e)}}function te(t,e){let r=N(t,e);if(r.length!==1||r[0].type!=="identifier")throw new Error("expected single branch name argument");return{type:"branch",ref:r[0].value}}function ee(t){if(tt(t)&&rt(t.child))throw new Error(`a ${t.type} node must have a single child node defined`);if(et(t)&&!t.children?.length)throw new Error(`a ${t.type} node must have at least a single child node defined`);if(t.type==="lotto"&&typeof t.weights<"u"&&t.weights.length!==t.children.length)throw new Error("expected a number of weight arguments matching the number of child nodes for lotto node")}function ot(t){return t===null||typeof t>"u"?w("definition is null or undefined"):typeof t=="string"?re(t):typeof t=="object"?it(t):w(`unexpected definition type of '${typeof t}'`)}function re(t){let e;try{e=C(t)}catch(n){return w(n.message)}let r=e.filter(({id:n})=>typeof n>"u"),o=e.filter(({id:n})=>typeof n=="string"&&n.length>0);if(r.length!==1)return w("expected single unnamed root node at base of definition to act as main root");let i=[];for(let{id:n}of o){if(i.includes(n))return w(`multiple root nodes found with duplicate name '${n}'`);i.push(n)}try{nt(e,!1)}catch(n){return w(n.message)}return{succeeded:!0,json:e}}function it(t){let e=Array.isArray(t)?t:[t];try{e.forEach(n=>y(n,0))}catch(n){return n instanceof Error?w(n.message):w(`unexpected error: ${n}`)}let r=e.filter(({id:n})=>typeof n>"u"),o=e.filter(({id:n})=>typeof n=="string"&&n.length>0);if(r.length!==1)return w("expected single root node without 'id' property defined to act as main root");let i=[];for(let{id:n}of o){if(i.includes(n))return w(`multiple root nodes found with duplicate 'id' property value of '${n}'`);i.push(n)}try{nt(e,!1)}catch(n){return w(n.message)}return{succeeded:!0,json:e}}function nt(t,e){let r=t.map(i=>({id:i.id,refs:Nt(i).filter(yt).map(({ref:n})=>n)})),o=(i,n=[])=>{if(n.includes(i.id)){let s=[...n,i.id].filter(c=>!!c).join(" => ");throw new Error(`circular dependency found in branch node references: ${s}`)}for(let a of i.refs){let s=r.find(({id:c})=>c===a);if(s)o(s,[...n,i.id]);else if(e)throw new Error(i.id?`subtree '${i.id}' has branch node that references root node '${a}' which has not been defined`:`primary tree has branch node that references root node '${a}' which has not been defined`)}};o(r.find(i=>typeof i.id>"u"))}function y(t,e){if(typeof t!="object"||typeof t.type!="string"||t.type.length===0)throw new Error(`node definition is not an object or 'type' property is not a non-empty string at depth '${e}'`);if(e===0&&t.type!=="root")throw new Error(`expected root node at base of definition but got node of type '${t.type}'`);switch(t.type){case"action":de(t,e);break;case"condition":le(t,e);break;case"wait":pe(t,e);break;case"branch":ce(t,e);break;case"root":oe(t,e);break;case"succeed":ie(t,e);break;case"fail":ne(t,e);break;case"flip":ae(t,e);break;case"repeat":se(t,e);break;case"retry":ue(t,e);break;case"sequence":fe(t,e);break;case"selector":he(t,e);break;case"parallel":me(t,e);break;case"race":ge(t,e);break;case"all":ye(t,e);break;case"lotto":be(t,e);break;default:throw new Error(`unexpected node type of '${t.type}' at depth '${e}'`)}}function f(t,e){["while","until","entry","exit","step"].forEach(r=>{let o=t[r];if(!(typeof o>"u")){if(typeof o!="object")throw new Error(`expected attribute '${r}' to be an object for '${t.type}' node at depth '${e}'`);if(typeof o.call!="string"||o.call.length===0)throw new Error(`expected 'call' property for attribute '${r}' to be a non-empty string for '${t.type}' node at depth '${e}'`);if(typeof o.args<"u"&&!Array.isArray(o.args))throw new Error(`expected 'args' property for attribute '${r}' to be an array for '${t.type}' node at depth '${e}'`)}})}function oe(t,e){if(t.type!=="root")throw new Error("expected node type of 'root' for root node");if(e>0)throw new Error("a root node cannot be the child of another node");if(typeof t.id<"u"&&(typeof t.id!="string"||t.id.length===0))throw new Error("expected non-empty string for 'id' property if defined for root node");if(typeof t.child>"u")throw new Error("expected property 'child' to be defined for root node");f(t,e),y(t.child,e+1)}function ie(t,e){if(t.type!=="succeed")throw new Error(`expected node type of 'succeed' for succeed node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for succeed node at depth '${e}'`);f(t,e),y(t.child,e+1)}function ne(t,e){if(t.type!=="fail")throw new Error(`expected node type of 'fail' for fail node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for fail node at depth '${e}'`);f(t,e),y(t.child,e+1)}function ae(t,e){if(t.type!=="flip")throw new Error(`expected node type of 'flip' for flip node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for flip node at depth '${e}'`);f(t,e),y(t.child,e+1)}function se(t,e){if(t.type!=="repeat")throw new Error(`expected node type of 'repeat' for repeat node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for repeat node at depth '${e}'`);if(typeof t.iterations<"u")if(Array.isArray(t.iterations)){let r=!!t.iterations.filter(o=>!b(o)).length;if(t.iterations.length!==2||r)throw new Error(`expected array containing two integer values for 'iterations' property if defined for repeat node at depth '${e}'`);if(t.iterations[0]<0||t.iterations[1]<0)throw new Error(`expected positive minimum and maximum iterations count for 'iterations' property if defined for repeat node at depth '${e}'`);if(t.iterations[0]>t.iterations[1])throw new Error(`expected minimum iterations count that does not exceed the maximum iterations count for 'iterations' property if defined for repeat node at depth '${e}'`)}else if(b(t.iterations)){if(t.iterations<0)throw new Error(`expected positive iterations count for 'iterations' property if defined for repeat node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'iterations' property if defined for repeat node at depth '${e}'`);f(t,e),y(t.child,e+1)}function ue(t,e){if(t.type!=="retry")throw new Error(`expected node type of 'retry' for retry node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for retry node at depth '${e}'`);if(typeof t.attempts<"u")if(Array.isArray(t.attempts)){let r=!!t.attempts.filter(o=>!b(o)).length;if(t.attempts.length!==2||r)throw new Error(`expected array containing two integer values for 'attempts' property if defined for retry node at depth '${e}'`);if(t.attempts[0]<0||t.attempts[1]<0)throw new Error(`expected positive minimum and maximum attempts count for 'attempts' property if defined for retry node at depth '${e}'`);if(t.attempts[0]>t.attempts[1])throw new Error(`expected minimum attempts count that does not exceed the maximum attempts count for 'attempts' property if defined for retry node at depth '${e}'`)}else if(b(t.attempts)){if(t.attempts<0)throw new Error(`expected positive attempts count for 'attempts' property if defined for retry node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'attempts' property if defined for retry node at depth '${e}'`);f(t,e),y(t.child,e+1)}function ce(t,e){if(t.type!=="branch")throw new Error(`expected node type of 'branch' for branch node at depth '${e}'`);if(typeof t.ref!="string"||t.ref.length===0)throw new Error(`expected non-empty string for 'ref' property for branch node at depth '${e}'`);["while","until"].forEach(r=>{if(typeof t[r]<"u")throw new Error(`guards should not be defined for branch nodes but guard '${r}' was defined for branch node at depth '${e}'`)}),["entry","exit","step"].forEach(r=>{if(typeof t[r]<"u")throw new Error(`callbacks should not be defined for branch nodes but callback '${r}' was defined for branch node at depth '${e}'`)})}function de(t,e){if(t.type!=="action")throw new Error(`expected node type of 'action' for action node at depth '${e}'`);if(typeof t.call!="string"||t.call.length===0)throw new Error(`expected non-empty string for 'call' property of action node at depth '${e}'`);if(typeof t.args<"u"&&!Array.isArray(t.args))throw new Error(`expected array for 'args' property if defined for action node at depth '${e}'`);f(t,e)}function le(t,e){if(t.type!=="condition")throw new Error(`expected node type of 'condition' for condition node at depth '${e}'`);if(typeof t.call!="string"||t.call.length===0)throw new Error(`expected non-empty string for 'call' property of condition node at depth '${e}'`);if(typeof t.args<"u"&&!Array.isArray(t.args))throw new Error(`expected array for 'args' property if defined for condition node at depth '${e}'`);f(t,e)}function pe(t,e){if(t.type!=="wait")throw new Error(`expected node type of 'wait' for wait node at depth '${e}'`);if(typeof t.duration<"u")if(Array.isArray(t.duration)){let r=!!t.duration.filter(o=>!b(o)).length;if(t.duration.length!==2||r)throw new Error(`expected array containing two integer values for 'duration' property if defined for wait node at depth '${e}'`);if(t.duration[0]<0||t.duration[1]<0)throw new Error(`expected positive minimum and maximum duration for 'duration' property if defined for wait node at depth '${e}'`);if(t.duration[0]>t.duration[1])throw new Error(`expected minimum duration value that does not exceed the maximum duration value for 'duration' property if defined for wait node at depth '${e}'`)}else if(b(t.duration)){if(t.duration<0)throw new Error(`expected positive duration value for 'duration' property if defined for wait node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'duration' property if defined for wait node at depth '${e}'`);f(t,e)}function fe(t,e){if(t.type!=="sequence")throw new Error(`expected node type of 'sequence' for sequence node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for sequence node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function he(t,e){if(t.type!=="selector")throw new Error(`expected node type of 'selector' for selector node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for selector node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function me(t,e){if(t.type!=="parallel")throw new Error(`expected node type of 'parallel' for parallel node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for parallel node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function ge(t,e){if(t.type!=="race")throw new Error(`expected node type of 'race' for race node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for race node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function ye(t,e){if(t.type!=="all")throw new Error(`expected node type of 'all' for all node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for all node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function be(t,e){if(t.type!=="lotto")throw new Error(`expected node type of 'lotto' for lotto node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for lotto node at depth '${e}'`);if(typeof t.weights<"u"&&(!Array.isArray(t.weights)||t.weights.length!==t.children.length||t.weights.filter(r=>!b(r)).length||t.weights.filter(r=>r<0).length))throw new Error(`expected an array of positive integer weight values with a length matching the number of child nodes for 'weights' property if defined for lotto node at depth '${e}'`);f(t,e),t.children.forEach(r=>y(r,e+1))}function w(t){return{succeeded:!1,errorMessage:t}}var S=class extends Error{constructor(r,o){super("A guard path condition has failed");this.source=r;this.guard=o}isSourceNode(r){return r===this.source}};var U=class{constructor(e){this.nodes=e}evaluate(e){for(let r of this.nodes)for(let o of r.guards)if(!o.isSatisfied(e))throw new S(r.node,o)}};function At(){let t=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}var E=class{constructor(e,r,o){this.type=e;this.options=o;this.uid=At(),this.attributes={entry:r.find(({type:i})=>i==="entry"),step:r.find(({type:i})=>i==="step"),exit:r.find(({type:i})=>i==="exit"),while:r.find(({type:i})=>i==="while"),until:r.find(({type:i})=>i==="until")}}uid;attributes;_state="mistreevous.ready";_guardPath;getState=()=>this._state;setState=e=>{let r=this._state;this._state=e,r!==e&&this.onStateChanged(r)};getUid=()=>this.uid;getType=()=>this.type;getAttributes=()=>Object.values(this.attributes).filter(e=>!!e);setGuardPath=e=>this._guardPath=e;hasGuardPath=()=>!!this._guardPath;is(e){return this._state===e}reset(){this.setState("mistreevous.ready")}abort(e){this.is("mistreevous.running")&&(this.reset(),this.attributes.exit?.callAgentFunction(e,!1,!0))}update(e){if(!(this.is("mistreevous.succeeded")||this.is("mistreevous.failed")))try{this._guardPath.evaluate(e),this.is("mistreevous.ready")&&this.attributes.entry?.callAgentFunction(e),this.attributes.step?.callAgentFunction(e),this.onUpdate(e),(this.is("mistreevous.succeeded")||this.is("mistreevous.failed"))&&this.attributes.exit?.callAgentFunction(e,this.is("mistreevous.succeeded"),!1)}catch(r){if(r instanceof S&&r.isSourceNode(this))this.abort(e),this.setState(r.guard.succeedOnAbort?"mistreevous.succeeded":"mistreevous.failed");else throw r}}getDetails(){return{id:this.uid,name:this.getName(),type:this.type,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),state:this._state}}onStateChanged(e){this.options.onNodeStateChange?.({id:this.uid,type:this.type,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:e,state:this._state})}};var A=class extends E{};var h=class extends E{constructor(r,o,i,n){super(r,o,i);this.children=n}getChildren=()=>this.children;reset=()=>{this.setState("mistreevous.ready"),this.children.forEach(r=>r.reset())};abort=r=>{this.is("mistreevous.running")&&(this.children.forEach(o=>o.abort(r)),this.reset(),this.attributes.exit?.callAgentFunction(r,!1,!0))};getDetails(){return{...super.getDetails(),children:this.children.map(r=>r.getDetails())}}};var F=class extends h{constructor(e,r,o){super("parallel",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.find(r=>r.is("mistreevous.failed"))){this.setState("mistreevous.failed");for(let r of this.children)r.getState()==="mistreevous.running"&&r.abort(e);return}if(this.children.every(r=>r.is("mistreevous.succeeded"))){this.setState("mistreevous.succeeded");return}this.setState("mistreevous.running")}getName=()=>"PARALLEL"};var T=class extends h{constructor(e,r,o){super("race",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.find(r=>r.is("mistreevous.succeeded"))){this.setState("mistreevous.succeeded");for(let r of this.children)r.getState()==="mistreevous.running"&&r.abort(e);return}if(this.children.every(r=>r.is("mistreevous.failed"))){this.setState("mistreevous.failed");return}this.setState("mistreevous.running")}getName=()=>"RACE"};var L=class extends h{constructor(e,r,o){super("all",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.every(r=>r.is("mistreevous.succeeded")||r.is("mistreevous.failed"))){this.setState(this.children.find(r=>r.is("mistreevous.succeeded"))?"mistreevous.succeeded":"mistreevous.failed");return}this.setState("mistreevous.running")}getName=()=>"ALL"};var O=class extends h{constructor(r,o,i){super("selector",r,o,i);this.children=i}onUpdate(r){for(let o of this.children){if((o.getState()==="mistreevous.ready"||o.getState()==="mistreevous.running")&&o.update(r),o.getState()==="mistreevous.succeeded"){this.setState("mistreevous.succeeded");return}if(o.getState()==="mistreevous.failed")if(this.children.indexOf(o)===this.children.length-1){this.setState("mistreevous.failed");return}else continue;if(o.getState()==="mistreevous.running"){this.setState("mistreevous.running");return}throw new Error("child node was not in an expected state.")}}getName=()=>"SELECTOR"};var P=class extends h{constructor(r,o,i){super("sequence",r,o,i);this.children=i}onUpdate(r){for(let o of this.children){if((o.getState()==="mistreevous.ready"||o.getState()==="mistreevous.running")&&o.update(r),o.getState()==="mistreevous.succeeded")if(this.children.indexOf(o)===this.children.length-1){this.setState("mistreevous.succeeded");return}else continue;if(o.getState()==="mistreevous.failed"){this.setState("mistreevous.failed");return}if(o.getState()==="mistreevous.running"){this.setState("mistreevous.running");return}throw new Error("child node was not in an expected state.")}}getName=()=>"SEQUENCE"};var Rt=Lt(xt());var k=class extends h{constructor(r,o,i,n){super("lotto",r,o,n);this.weights=i}selectedChild;onUpdate(r){if(this.is("mistreevous.ready")){let o=(0,Rt.default)({random:this.options.random,participants:this.children.map((i,n)=>[i,this.weights?.[n]||1])});this.selectedChild=o.draw()||void 0}if(!this.selectedChild)throw new Error("failed to update lotto node as it has no active child");(this.selectedChild.getState()==="mistreevous.ready"||this.selectedChild.getState()==="mistreevous.running")&&this.selectedChild.update(r),this.setState(this.selectedChild.getState())}getName=()=>this.weights?`LOTTO [${this.weights.join(",")}]`:"LOTTO"};var m=class extends E{constructor(r,o,i,n){super(r,o,i);this.child=n}getChildren=()=>[this.child];reset=()=>{this.setState("mistreevous.ready"),this.child.reset()};abort=r=>{this.is("mistreevous.running")&&(this.child.abort(r),this.reset(),this.attributes.exit?.callAgentFunction(r,!1,!0))};getDetails(){return{...super.getDetails(),children:[this.child.getDetails()]}}};var M=class extends m{constructor(e,r,o){super("fail",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":case"mistreevous.failed":this.setState("mistreevous.failed");break;default:this.setState("mistreevous.ready")}}getName=()=>"FAIL"};var B=class extends m{constructor(e,r,o){super("flip",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":this.setState("mistreevous.failed");break;case"mistreevous.failed":this.setState("mistreevous.succeeded");break;default:this.setState("mistreevous.ready")}}getName=()=>"FLIP"};var _=class extends m{constructor(r,o,i,n,a,s){super("repeat",r,o,s);this.iterations=i;this.iterationsMin=n;this.iterationsMax=a}targetIterationCount=null;currentIterationCount=0;onUpdate(r){if(this.is("mistreevous.ready")&&(this.child.reset(),this.currentIterationCount=0,this.setTargetIterationCount()),this.canIterate())if(this.setState("mistreevous.running"),this.child.getState()==="mistreevous.succeeded"&&this.child.reset(),this.child.update(r),this.child.getState()==="mistreevous.failed"){this.setState("mistreevous.failed");return}else this.child.getState()==="mistreevous.succeeded"&&(this.currentIterationCount+=1);else this.setState("mistreevous.succeeded")}getName=()=>this.iterations!==null?`REPEAT ${this.iterations}x`:this.iterationsMin!==null&&this.iterationsMax!==null?`REPEAT ${this.iterationsMin}x-${this.iterationsMax}x`:"REPEAT";reset=()=>{this.setState("mistreevous.ready"),this.currentIterationCount=0,this.child.reset()};canIterate=()=>this.targetIterationCount!==null?this.currentIterationCount<this.targetIterationCount:!0;setTargetIterationCount=()=>{if(this.iterations!==null)this.targetIterationCount=this.iterations;else if(this.iterationsMin!==null&&this.iterationsMax!==null){let r=typeof this.options.random=="function"?this.options.random:Math.random;this.targetIterationCount=Math.floor(r()*(this.iterationsMax-this.iterationsMin+1)+this.iterationsMin)}else this.targetIterationCount=null}};var j=class extends m{constructor(r,o,i,n,a,s){super("retry",r,o,s);this.attempts=i;this.attemptsMin=n;this.attemptsMax=a}targetAttemptCount=null;currentAttemptCount=0;onUpdate(r){if(this.is("mistreevous.ready")&&(this.child.reset(),this.currentAttemptCount=0,this.setTargetAttemptCount()),this.canAttempt())if(this.setState("mistreevous.running"),this.child.getState()==="mistreevous.failed"&&this.child.reset(),this.child.update(r),this.child.getState()==="mistreevous.succeeded"){this.setState("mistreevous.succeeded");return}else this.child.getState()==="mistreevous.failed"&&(this.currentAttemptCount+=1);else this.setState("mistreevous.failed")}getName=()=>this.attempts!==null?`RETRY ${this.attempts}x`:this.attemptsMin!==null&&this.attemptsMax!==null?`RETRY ${this.attemptsMin}x-${this.attemptsMax}x`:"RETRY";reset=()=>{this.setState("mistreevous.ready"),this.currentAttemptCount=0,this.child.reset()};canAttempt=()=>this.targetAttemptCount!==null?this.currentAttemptCount<this.targetAttemptCount:!0;setTargetAttemptCount=()=>{if(this.attempts!==null)this.targetAttemptCount=this.attempts;else if(this.attemptsMin!==null&&this.attemptsMax!==null){let r=typeof this.options.random=="function"?this.options.random:Math.random;this.targetAttemptCount=Math.floor(r()*(this.attemptsMax-this.attemptsMin+1)+this.attemptsMin)}else this.targetAttemptCount=null}};var Y=class extends m{constructor(e,r,o){super("root",e,r,o)}onUpdate(e){(this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.setState(this.child.getState())}getName=()=>"ROOT"};var q=class extends m{constructor(e,r,o){super("succeed",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":case"mistreevous.failed":this.setState("mistreevous.succeeded");break;default:this.setState("mistreevous.ready")}}getName=()=>"SUCCEED"};var W=class extends A{constructor(r,o,i,n){super("action",r,o);this.actionName=i;this.actionArguments=n}isUsingUpdatePromise=!1;updatePromiseResult=null;onUpdate(r){if(this.isUsingUpdatePromise){if(!this.updatePromiseResult)return;let{isResolved:n,value:a}=this.updatePromiseResult;if(n){if(a!=="mistreevous.succeeded"&&a!=="mistreevous.failed")throw new Error("action node promise resolved with an invalid value, expected a State.SUCCEEDED or State.FAILED value to be returned");this.setState(a);return}else throw new Error(`action function '${this.actionName}' promise rejected with '${a}'`)}let o=u.getFuncInvoker(r,this.actionName);if(o===null)throw new Error(`cannot update action node as the action '${this.actionName}' function is not defined on the agent and has not been registered`);let i;try{i=o(this.actionArguments)}catch(n){throw n instanceof Error?new Error(`action function '${this.actionName}' threw: ${n.stack}`):new Error(`action function '${this.actionName}' threw: ${n}`)}i instanceof Promise?(i.then(n=>{this.isUsingUpdatePromise&&(this.updatePromiseResult={isResolved:!0,value:n})},n=>{this.isUsingUpdatePromise&&(this.updatePromiseResult={isResolved:!1,value:n})}),this.setState("mistreevous.running"),this.isUsingUpdatePromise=!0):(this.validateUpdateResult(i),this.setState(i||"mistreevous.running"))}getName=()=>this.actionName;reset=()=>{this.setState("mistreevous.ready"),this.isUsingUpdatePromise=!1,this.updatePromiseResult=null};getDetails(){return{...super.getDetails(),args:this.actionArguments}}onStateChanged(r){this.options.onNodeStateChange?.({id:this.uid,type:this.getType(),args:this.actionArguments,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:r,state:this.getState()})}validateUpdateResult=r=>{switch(r){case"mistreevous.succeeded":case"mistreevous.failed":case"mistreevous.running":case void 0:return;default:throw new Error(`expected action function '${this.actionName}' to return an optional State.SUCCEEDED or State.FAILED value but returned '${r}'`)}}};var J=class extends A{constructor(r,o,i,n){super("condition",r,o);this.conditionName=i;this.conditionArguments=n}onUpdate(r){let o=u.getFuncInvoker(r,this.conditionName);if(o===null)throw new Error(`cannot update condition node as the condition '${this.conditionName}' function is not defined on the agent and has not been registered`);let i;try{i=o(this.conditionArguments)}catch(n){throw n instanceof Error?new Error(`condition function '${this.conditionName}' threw: ${n.stack}`):new Error(`condition function '${this.conditionName}' threw: ${n}`)}if(typeof i!="boolean")throw new Error(`expected condition function '${this.conditionName}' to return a boolean but returned '${i}'`);this.setState(i?"mistreevous.succeeded":"mistreevous.failed")}getName=()=>this.conditionName;getDetails(){return{...super.getDetails(),args:this.conditionArguments}}onStateChanged(r){this.options.onNodeStateChange?.({id:this.uid,type:this.getType(),args:this.conditionArguments,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:r,state:this.getState()})}};var V=class extends A{constructor(r,o,i,n,a){super("wait",r,o);this.duration=i;this.durationMin=n;this.durationMax=a}initialUpdateTime=0;totalDuration=null;waitedDuration=0;onUpdate(r){if(this.is("mistreevous.ready")){if(this.initialUpdateTime=new Date().getTime(),this.waitedDuration=0,this.duration!==null)this.totalDuration=this.duration;else if(this.durationMin!==null&&this.durationMax!==null){let o=typeof this.options.random=="function"?this.options.random:Math.random;this.totalDuration=Math.floor(o()*(this.durationMax-this.durationMin+1)+this.durationMin)}else this.totalDuration=null;this.setState("mistreevous.running")}if(this.totalDuration!==null){if(typeof this.options.getDeltaTime=="function"){let o=this.options.getDeltaTime();if(typeof o!="number"||isNaN(o))throw new Error("The delta time must be a valid number and not NaN.");this.waitedDuration+=o*1e3}else this.waitedDuration=new Date().getTime()-this.initialUpdateTime;this.waitedDuration>=this.totalDuration&&this.setState("mistreevous.succeeded")}}getName=()=>this.duration!==null?`WAIT ${this.duration}ms`:this.durationMin!==null&&this.durationMax!==null?`WAIT ${this.durationMin}ms-${this.durationMax}ms`:"WAIT"};var x=class{constructor(e,r){this.type=e;this.args=r}};var D=class extends x{constructor(r,o){super(r,o.args??[]);this.definition=o}get condition(){return this.definition.call}get succeedOnAbort(){return!!this.definition.succeedOnAbort}getDetails(){return{type:this.type,args:this.args,calls:this.condition,succeedOnAbort:this.succeedOnAbort}}};var z=class extends D{constructor(e){super("while",e)}isSatisfied=e=>{let r=u.getFuncInvoker(e,this.condition);if(r===null)throw new Error(`cannot evaluate node guard as the condition '${this.condition}' function is not defined on the agent and has not been registered`);let o;try{o=r(this.args)}catch(i){throw i instanceof Error?new Error(`guard condition function '${this.condition}' threw: ${i.stack}`):new Error(`guard condition function '${this.condition}' threw: ${i}`)}if(typeof o!="boolean")throw new Error(`expected guard condition function '${this.condition}' to return a boolean but returned '${o}'`);return o}};var Q=class extends D{constructor(e){super("until",e)}isSatisfied=e=>{let r=u.getFuncInvoker(e,this.condition);if(r===null)throw new Error(`cannot evaluate node guard as the condition '${this.condition}' function is not defined on the agent and has not been registered`);let o;try{o=r(this.args)}catch(i){throw i instanceof Error?new Error(`guard condition function '${this.condition}' threw: ${i.stack}`):new Error(`guard condition function '${this.condition}' threw: ${i}`)}if(typeof o!="boolean")throw new Error(`expected guard condition function '${this.condition}' to return a boolean but returned '${o}'`);return!o}};var v=class extends x{constructor(r,o,i){super(r,o);this.functionName=i}getFunctionName=()=>this.functionName;getDetails(){return{type:this.type,args:this.args,calls:this.getFunctionName()}}};var Z=class extends v{constructor(e,r){super("entry",r,e)}callAgentFunction=e=>{let r=u.getFuncInvoker(e,this.getFunctionName());if(r===null)throw new Error(`cannot call entry function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);r(this.args)}};var H=class extends v{constructor(e,r){super("step",r,e)}callAgentFunction=e=>{let r=u.getFuncInvoker(e,this.getFunctionName());if(r===null)throw new Error(`cannot call step function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);r(this.args)}};var K=class extends v{constructor(e,r){super("exit",r,e)}callAgentFunction=(e,r,o)=>{let i=u.getFuncInvoker(e,this.getFunctionName());if(i===null)throw new Error(`cannot call exit function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);i([{succeeded:r,aborted:o},...this.args])}};var pt=Symbol("__root__");function ft(t,e){let r=Re(t);nt([r[pt],...Object.values(r)],!0);let o=g(r[pt],r,e);return Ce(o),o}function g(t,e,r){let o=xe(t);switch(t.type){case"root":return new Y(o,r,g(t.child,e,r));case"repeat":{let i=null,n=null,a=null;return Array.isArray(t.iterations)?(n=t.iterations[0],a=t.iterations[1]):b(t.iterations)&&(i=t.iterations),new _(o,r,i,n,a,g(t.child,e,r))}case"retry":{let i=null,n=null,a=null;return Array.isArray(t.attempts)?(n=t.attempts[0],a=t.attempts[1]):b(t.attempts)&&(i=t.attempts),new j(o,r,i,n,a,g(t.child,e,r))}case"flip":return new B(o,r,g(t.child,e,r));case"succeed":return new q(o,r,g(t.child,e,r));case"fail":return new M(o,r,g(t.child,e,r));case"sequence":return new P(o,r,t.children.map(i=>g(i,e,r)));case"selector":return new O(o,r,t.children.map(i=>g(i,e,r)));case"parallel":return new F(o,r,t.children.map(i=>g(i,e,r)));case"race":return new T(o,r,t.children.map(i=>g(i,e,r)));case"all":return new L(o,r,t.children.map(i=>g(i,e,r)));case"lotto":return new k(o,r,t.weights,t.children.map(i=>g(i,e,r)));case"branch":return g(e[t.ref].child,e,r);case"action":return new W(o,r,t.call,t.args||[]);case"condition":return new J(o,r,t.call,t.args||[]);case"wait":{let i=null,n=null,a=null;return Array.isArray(t.duration)?(n=t.duration[0],a=t.duration[1]):b(t.duration)&&(i=t.duration),new V(o,r,i,n,a)}}}function xe(t){let e=[];return t.while&&e.push(new z(t.while)),t.until&&e.push(new Q(t.until)),t.entry&&e.push(new Z(t.entry.call,t.entry.args??[])),t.step&&e.push(new H(t.step.call,t.step.args??[])),t.exit&&e.push(new K(t.exit.call,t.exit.args??[])),e}function Re(t){let e={};for(let[r,o]of Object.entries(u.getSubtrees()))e[r]={...o,id:r};for(let r of t)e[r.id??pt]=r;return e}function Ce(t){let e=[],r=(o,i)=>{o=o.concat(i),i instanceof A?e.push(o):i.getChildren().forEach(n=>r(o,n))};r([],t),e.forEach(o=>{for(let i=0;i<o.length;i++){let n=o[i];if(n.hasGuardPath())continue;let a=new U(o.slice(0,i+1).map(s=>({node:s,guards:s.getAttributes().filter(c=>c instanceof D)})).filter(s=>s.guards.length>0));n.setGuardPath(a)}})}var ct=class{constructor(e,r,o={}){this.agent=r;this.options=o;if(rt(e))throw new Error("tree definition not defined");if(typeof r!="object"||r===null)throw new Error("the agent must be an object and not null");let{succeeded:i,errorMessage:n,json:a}=ot(e);if(!i)throw new Error(`invalid definition: ${n}`);if(!a)throw new Error("expected json definition to be returned as part of successful definition validation response");try{this._rootNode=ft(a,o)}catch(s){throw new Error(`error building tree: ${s.message}`)}}_rootNode;isRunning(){return this._rootNode.getState()==="mistreevous.running"}getState(){return this._rootNode.getState()}step(){(this._rootNode.getState()==="mistreevous.succeeded"||this._rootNode.getState()==="mistreevous.failed")&&this._rootNode.reset();try{this._rootNode.update(this.agent)}catch(e){throw new Error(`error stepping tree: ${e.message}`)}}reset(){this._rootNode.reset()}getTreeNodeDetails(){return this._rootNode.getDetails()}static register(e,r){if(typeof r=="function"){u.setFunc(e,r);return}if(typeof r=="string"){let o;try{o=C(r)}catch(i){throw new Error(`error registering definition, invalid MDSL: ${i.message}`)}if(o.length!=1||typeof o[0].id<"u")throw new Error("error registering definition: expected a single unnamed root node");try{let{succeeded:i,errorMessage:n}=it(o[0]);if(!i)throw new Error(n)}catch(i){throw new Error(`error registering definition: ${i.message}`)}u.setSubtree(e,o[0])}else if(typeof r=="object"&&!Array.isArray(r)){try{let{succeeded:o,errorMessage:i}=it(r);if(!o)throw new Error(i)}catch(o){throw new Error(`error registering definition: ${o.message}`)}u.setSubtree(e,r)}else throw new Error("unexpected value, expected string mdsl definition, root node json definition or function")}static unregister(e){u.remove(e)}static unregisterAll(){u.empty()}};return Ot(Ie);})();
//# sourceMappingURL=mistreevous.min.js.map
