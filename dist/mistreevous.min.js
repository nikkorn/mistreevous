"use strict";var mistreevous=(()=>{var Tt=Object.create;var $=Object.defineProperty;var Lt=Object.getOwnPropertyDescriptor;var Ot=Object.getOwnPropertyNames;var Pt=Object.getPrototypeOf,Gt=Object.prototype.hasOwnProperty;var kt=(t,e,r)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var F=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Mt=(t,e)=>{for(var r in e)$(t,r,{get:e[r],enumerable:!0})},Nt=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ot(e))!Gt.call(t,i)&&i!==r&&$(t,i,{get:()=>e[i],enumerable:!(o=Lt(e,i))||o.enumerable});return t};var Bt=(t,e,r)=>(r=t!=null?Tt(Pt(t)):{},Nt(e||!t||!t.__esModule?$(r,"default",{value:t,enumerable:!0}):r,t)),_t=t=>Nt($({},"__esModule",{value:!0}),t);var ct=(t,e,r)=>(kt(t,typeof e!="symbol"?e+"":e,r),r);var Rt=F(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});st.Participant=void 0;var ve=function(){function t(e,r){r===void 0&&(r=1),this._participant=e,this._tickets=r}return Object.defineProperty(t.prototype,"participant",{get:function(){return this._participant},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tickets",{get:function(){return this._tickets},set:function(e){this._tickets=e},enumerable:!1,configurable:!0}),t}();st.Participant=ve});var Ct=F(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.isNaturalNumber=I.isNullOrUndefined=void 0;function Se(t){return t==null}I.isNullOrUndefined=Se;function xe(t){return typeof t=="number"&&t>=1&&Math.floor(t)===t}I.isNaturalNumber=xe});var It=F(ut=>{"use strict";Object.defineProperty(ut,"__esModule",{value:!0});ut.Lotto=void 0;var Re=Rt(),M=Ct(),Ce=function(){function t(e){this._participants=[],this._customRandom=e}return t.prototype.add=function(e,r){if(r===void 0&&(r=1),!(0,M.isNaturalNumber)(r))throw new Error("tickets value must be a natural number");var o=this._participants.find(function(i){return i.participant===e});return o?o.tickets+=r:this._participants.push(new Re.Participant(e,r)),this},t.prototype.remove=function(e,r){var o=this._participants.find(function(i){return i.participant===e});if(!o)return this;if(r!==void 0){if(!(0,M.isNaturalNumber)(r))throw new Error("tickets value must be a natural number");o.tickets-=r,o.tickets<1&&(this._participants=this._participants.filter(function(i){return i!==o}))}else this._participants=this._participants.filter(function(i){return i!==o});return this},t.prototype.draw=function(e){if(e===void 0&&(e={}),this._participants.length===0)return null;var r=(0,M.isNullOrUndefined)(e.redrawable)?!0:e.redrawable,o=[];this._participants.forEach(function(a){for(var s=a.participant,d=a.tickets,U=0;U<d;U++)o.push(s)});var i;if(this._customRandom){if(i=this._customRandom(),typeof i!="number"||i<0||i>=1)throw new Error("the 'random' function provided did not return a number between 0 (inclusive) and 1")}else i=Math.random();var n=o[Math.floor(i*o.length)];return r||this.remove(n,1),n},t.prototype.drawMultiple=function(e,r){r===void 0&&(r={});var o=(0,M.isNullOrUndefined)(r.unique)?!1:r.unique;if(e===0)return[];if(!(0,M.isNaturalNumber)(e))throw new Error("tickets value must be a natural number");for(var i=[];i.length<e&&this._participants.length>0;)i.push(this.draw(r));if(o){for(var n=[],a=0,s=i;a<s.length;a++){var d=s[a];n.indexOf(d)===-1&&n.push(d)}i=n}return i},t}();ut.Lotto=Ce});var Ut=F(dt=>{"use strict";Object.defineProperty(dt,"__esModule",{value:!0});dt.createLotto=void 0;var pt=It();function Ie(t){if(!t)return new pt.Lotto;if(Array.isArray(t)){var e=t,r=new pt.Lotto;return e.forEach(function(n){var a=n[0],s=n[1];return r.add(a,s)}),r}else{var o=t.random,e=t.participants,i=new pt.Lotto(o);return e&&e.forEach(function(a){var s=a[0],d=a[1];return i.add(s,d)}),i}}dt.createLotto=Ie});var $t=F(ft=>{"use strict";Object.defineProperty(ft,"__esModule",{value:!0});var Ue=Ut();ft.default=Ue.createLotto});var Le={};Mt(Le,{BehaviourTree:()=>lt,State:()=>l,convertMDSLToJSON:()=>C,validateDefinition:()=>it});var l=(i=>(i.READY="mistreevous.ready",i.RUNNING="mistreevous.running",i.SUCCEEDED="mistreevous.succeeded",i.FAILED="mistreevous.failed",i))(l||{});var u=class{static getFunc(e){return this.registeredFunctions[e]}static setFunc(e,r){this.registeredFunctions[e]=r}static getFuncInvoker(e,r){let o=e[r];if(o&&typeof o=="function")return i=>o.apply(e,i);if(this.registeredFunctions[r]&&typeof this.registeredFunctions[r]=="function"){let i=this.registeredFunctions[r];return n=>i(e,...n)}return null}static getSubtrees(){return this.registeredSubtrees}static setSubtree(e,r){this.registeredSubtrees[e]=r}static remove(e){delete this.registeredFunctions[e],delete this.registeredSubtrees[e]}static empty(){this.registeredFunctions={},this.registeredSubtrees={}}};ct(u,"registeredFunctions",{}),ct(u,"registeredSubtrees",{});function wt(t){return t.type==="root"}function At(t){return t.type==="branch"}function Et(t){return["branch","action","condition","wait"].includes(t.type)}function et(t){return["root","repeat","retry","flip","succeed","fail"].includes(t.type)}function rt(t){return["sequence","selector","lotto","parallel","race","all"].includes(t.type)}function Dt(t){let e=[],r=o=>{e.push(o),rt(o)?o.children.forEach(r):et(o)&&r(o.child)};return r(t),e}function y(t){return typeof t=="number"&&Math.floor(t)===t}function ot(t){return typeof t>"u"||t===null}function c(t,e){let r=t.shift();if(r===void 0)throw new Error("unexpected end of definition");if(e!=null){let i=typeof e=="string"?[e]:e;var o=i.some(n=>r.toUpperCase()===n.toUpperCase());if(!o){let n=i.map(a=>"'"+a+"'").join(" or ");throw new Error("unexpected token found. Expected "+n+" but got '"+r+"'")}}return r}function vt(t){let e={},r=t.replace(/\"(\\.|[^"\\])*\"/g,o=>{var i=o.substring(1,o.length-1),n=Object.keys(e).find(a=>e[a]===i);return n||(n=`@@${Object.keys(e).length}@@`,e[n]=i),n});return{placeholders:e,processedDefinition:r}}function St(t){return t=t.replace(/\(/g," ( "),t=t.replace(/\)/g," ) "),t=t.replace(/\{/g," { "),t=t.replace(/\}/g," } "),t=t.replace(/\]/g," ] "),t=t.replace(/\[/g," [ "),t=t.replace(/\,/g," , "),t.replace(/\s+/g," ").trim().split(" ")}function w(t,e){let r=[];if(!["[","("].includes(t[0]))return r;let o=c(t,["[","("])==="["?"]":")",i=[];for(;t.length&&t[0]!==o;)i.push(t.shift());return i.forEach((n,a)=>{if(!(a&1)){let d=Yt(n,e);r.push(d)}else if(n!==",")throw new Error(`invalid argument list, expected ',' or ']' but got '${n}'`)}),c(t,o),r}function Yt(t,e){return t==="null"?{value:null,type:"null"}:t==="true"||t==="false"?{value:t==="true",type:"boolean"}:isNaN(t)?t.match(/^@@\d+@@$/g)?{value:e[t].replace('\\"','"'),type:"string"}:{value:t,type:"identifier"}:{value:parseFloat(t),isInteger:parseFloat(t)===parseInt(t,10),type:"number"}}function p(t,e){let r=["while","until","entry","exit","step"],o={},i=t[0]?.toLowerCase();for(;r.includes(i);){if(o[i])throw new Error(`duplicate attribute '${t[0].toUpperCase()}' found for node`);t.shift();let[n,...a]=w(t,e);if(n?.type!=="identifier")throw new Error("expected agent function or registered function name identifier argument for attribute");a.filter(s=>s.type==="identifier").forEach(s=>{throw new Error(`invalid attribute argument value '${s.value}', must be string, number, boolean or null`)}),o[i]={call:n.value,args:a.map(({value:s})=>s)},i=t[0]?.toLowerCase()}return o}function C(t){let{placeholders:e,processedDefinition:r}=vt(t),o=St(r);return jt(o,e)}function jt(t,e){if(t.length<3)throw new Error("invalid token count");if(t.filter(a=>a==="{").length!==t.filter(a=>a==="}").length)throw new Error("scope character mismatch");let r=[],o=[],i=a=>{if(wt(a)){if(r[r.length-1]?.length)throw new Error("a root node cannot be the child of another node");o.push(a),r.push([a]);return}if(!r.length||!r[r.length-1].length)throw new Error("expected root node at base of definition");let s=r[r.length-1],d=s[s.length-1];if(rt(d))d.children=d.children||[],d.children.push(a);else if(et(d)){if(d.child)throw new Error("a decorator node must only have a single child node");d.child=a}Et(a)||s.push(a)},n=()=>{let a=null,s=r[r.length-1];return s.length&&(a=s.pop()),s.length||r.pop(),a};for(;t.length;){let a=t.shift();switch(a.toUpperCase()){case"ROOT":{i(qt(t,e));break}case"SUCCEED":{i(Wt(t,e));break}case"FAIL":{i(Jt(t,e));break}case"FLIP":{i(Vt(t,e));break}case"REPEAT":{i(Qt(t,e));break}case"RETRY":{i(Ht(t,e));break}case"SEQUENCE":{i(Kt(t,e));break}case"SELECTOR":{i(zt(t,e));break}case"PARALLEL":{i(Xt(t,e));break}case"RACE":{i(Zt(t,e));break}case"ALL":{i(te(t,e));break}case"LOTTO":{i(ee(t,e));break}case"ACTION":{i(re(t,e));break}case"CONDITION":{i(oe(t,e));break}case"WAIT":{i(ie(t,e));break}case"BRANCH":{i(ne(t,e));break}case"}":{let s=n();s&&ae(s);break}default:throw new Error(`unexpected token: ${a}`)}}return o}function qt(t,e){let r={type:"root"},o=w(t,e);if(o.length)if(o.length===1&&o[0].type==="identifier")r.id=o[0].value;else throw new Error("expected single root name argument");return r={...r,...p(t,e)},c(t,"{"),r}function Wt(t,e){let r={type:"succeed",...p(t,e)};return c(t,"{"),r}function Jt(t,e){let r={type:"fail",...p(t,e)};return c(t,"{"),r}function Vt(t,e){let r={type:"flip",...p(t,e)};return c(t,"{"),r}function Qt(t,e){let r={type:"repeat"},o=w(t,e);if(o.length)if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("repeat node iteration counts must be integer values")}),o.length===1){if(r.iterations=o[0].value,r.iterations<0)throw new Error("a repeat node must have a positive number of iterations if defined")}else if(o.length===2){if(r.iterations=[o[0].value,o[1].value],r.iterations[0]<0||r.iterations[1]<0)throw new Error("a repeat node must have a positive minimum and maximum iteration count if defined");if(r.iterations[0]>r.iterations[1])throw new Error("a repeat node must not have a minimum iteration count that exceeds the maximum iteration count")}else throw new Error("invalid number of repeat node iteration count arguments defined");return r={...r,...p(t,e)},c(t,"{"),r}function Ht(t,e){let r={type:"retry"},o=w(t,e);if(o.length)if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("retry node attempt counts must be integer values")}),o.length===1){if(r.attempts=o[0].value,r.attempts<0)throw new Error("a retry node must have a positive number of attempts if defined")}else if(o.length===2){if(r.attempts=[o[0].value,o[1].value],r.attempts[0]<0||r.attempts[1]<0)throw new Error("a retry node must have a positive minimum and maximum attempt count if defined");if(r.attempts[0]>r.attempts[1])throw new Error("a retry node must not have a minimum attempt count that exceeds the maximum attempt count")}else throw new Error("invalid number of retry node attempt count arguments defined");return r={...r,...p(t,e)},c(t,"{"),r}function Kt(t,e){let r={type:"sequence",...p(t,e)};return c(t,"{"),r}function zt(t,e){let r={type:"selector",...p(t,e)};return c(t,"{"),r}function Xt(t,e){let r={type:"parallel",...p(t,e)};return c(t,"{"),r}function Zt(t,e){let r={type:"race",...p(t,e)};return c(t,"{"),r}function te(t,e){let r={type:"all",...p(t,e)};return c(t,"{"),r}function ee(t,e){let r=w(t,e);r.filter(i=>i.type!=="number"||!i.isInteger||i.value<0).forEach(()=>{throw new Error("lotto node weight arguments must be positive integer values")});let o={type:"lotto",...p(t,e)};return r.length&&(o.weights=r.map(({value:i})=>i)),c(t,"{"),o}function re(t,e){let[r,...o]=w(t,e);if(r?.type!=="identifier")throw new Error("expected action name identifier argument");return o.filter(i=>i.type==="identifier").forEach(i=>{throw new Error(`invalid action node argument value '${i.value}', must be string, number, boolean or null`)}),{type:"action",call:r.value,args:o.map(({value:i})=>i),...p(t,e)}}function oe(t,e){let[r,...o]=w(t,e);if(r?.type!=="identifier")throw new Error("expected condition name identifier argument");return o.filter(i=>i.type==="identifier").forEach(i=>{throw new Error(`invalid condition node argument value '${i.value}', must be string, number, boolean or null`)}),{type:"condition",call:r.value,args:o.map(({value:i})=>i),...p(t,e)}}function ie(t,e){let r={type:"wait"},o=w(t,e);if(o.length){if(o.filter(i=>i.type!=="number"||!i.isInteger).forEach(()=>{throw new Error("wait node durations must be integer values")}),o.length===1){if(r.duration=o[0].value,r.duration<0)throw new Error("a wait node must have a positive duration")}else if(o.length===2){if(r.duration=[o[0].value,o[1].value],r.duration[0]<0||r.duration[1]<0)throw new Error("a wait node must have a positive minimum and maximum duration");if(r.duration[0]>r.duration[1])throw new Error("a wait node must not have a minimum duration that exceeds the maximum duration")}else if(o.length>2)throw new Error("invalid number of wait node duration arguments defined")}return{...r,...p(t,e)}}function ne(t,e){let r=w(t,e);if(r.length!==1||r[0].type!=="identifier")throw new Error("expected single branch name argument");return{type:"branch",ref:r[0].value}}function ae(t){if(et(t)&&ot(t.child))throw new Error(`a ${t.type} node must have a single child node defined`);if(rt(t)&&!t.children?.length)throw new Error(`a ${t.type} node must have at least a single child node defined`);if(t.type==="lotto"&&typeof t.weights<"u"&&t.weights.length!==t.children.length)throw new Error("expected a number of weight arguments matching the number of child nodes for lotto node")}function it(t){return t===null||typeof t>"u"?A("definition is null or undefined"):typeof t=="string"?se(t):typeof t=="object"?nt(t):A(`unexpected definition type of '${typeof t}'`)}function se(t){let e;try{e=C(t)}catch(n){return A(n.message)}let r=e.filter(({id:n})=>typeof n>"u"),o=e.filter(({id:n})=>typeof n=="string"&&n.length>0);if(r.length!==1)return A("expected single unnamed root node at base of definition to act as main root");let i=[];for(let{id:n}of o){if(i.includes(n))return A(`multiple root nodes found with duplicate name '${n}'`);i.push(n)}try{at(e,!1)}catch(n){return A(n.message)}return{succeeded:!0,json:e}}function nt(t){let e=Array.isArray(t)?t:[t];try{e.forEach(n=>b(n,0))}catch(n){return n instanceof Error?A(n.message):A(`unexpected error: ${n}`)}let r=e.filter(({id:n})=>typeof n>"u"),o=e.filter(({id:n})=>typeof n=="string"&&n.length>0);if(r.length!==1)return A("expected single root node without 'id' property defined to act as main root");let i=[];for(let{id:n}of o){if(i.includes(n))return A(`multiple root nodes found with duplicate 'id' property value of '${n}'`);i.push(n)}try{at(e,!1)}catch(n){return A(n.message)}return{succeeded:!0,json:e}}function at(t,e){let r=t.map(i=>({id:i.id,refs:Dt(i).filter(At).map(({ref:n})=>n)})),o=(i,n=[])=>{if(n.includes(i.id)){let s=[...n,i.id].filter(d=>!!d).join(" => ");throw new Error(`circular dependency found in branch node references: ${s}`)}for(let a of i.refs){let s=r.find(({id:d})=>d===a);if(s)o(s,[...n,i.id]);else if(e)throw new Error(i.id?`subtree '${i.id}' has branch node that references root node '${a}' which has not been defined`:`primary tree has branch node that references root node '${a}' which has not been defined`)}};o(r.find(i=>typeof i.id>"u"))}function b(t,e){if(typeof t!="object"||typeof t.type!="string"||t.type.length===0)throw new Error(`node definition is not an object or 'type' property is not a non-empty string at depth '${e}'`);if(e===0&&t.type!=="root")throw new Error(`expected root node at base of definition but got node of type '${t.type}'`);switch(t.type){case"action":me(t,e);break;case"condition":ge(t,e);break;case"wait":be(t,e);break;case"branch":he(t,e);break;case"root":ue(t,e);break;case"succeed":de(t,e);break;case"fail":le(t,e);break;case"flip":ce(t,e);break;case"repeat":pe(t,e);break;case"retry":fe(t,e);break;case"sequence":ye(t,e);break;case"selector":Ne(t,e);break;case"parallel":we(t,e);break;case"race":Ae(t,e);break;case"all":Ee(t,e);break;case"lotto":De(t,e);break;default:throw new Error(`unexpected node type of '${t.type}' at depth '${e}'`)}}function f(t,e){["while","until","entry","exit","step"].forEach(r=>{let o=t[r];if(!(typeof o>"u")){if(typeof o!="object")throw new Error(`expected attribute '${r}' to be an object for '${t.type}' node at depth '${e}'`);if(typeof o.call!="string"||o.call.length===0)throw new Error(`expected 'call' property for attribute '${r}' to be a non-empty string for '${t.type}' node at depth '${e}'`);if(typeof o.args<"u"&&!Array.isArray(o.args))throw new Error(`expected 'args' property for attribute '${r}' to be an array for '${t.type}' node at depth '${e}'`)}})}function ue(t,e){if(t.type!=="root")throw new Error("expected node type of 'root' for root node");if(e>0)throw new Error("a root node cannot be the child of another node");if(typeof t.id<"u"&&(typeof t.id!="string"||t.id.length===0))throw new Error("expected non-empty string for 'id' property if defined for root node");if(typeof t.child>"u")throw new Error("expected property 'child' to be defined for root node");f(t,e),b(t.child,e+1)}function de(t,e){if(t.type!=="succeed")throw new Error(`expected node type of 'succeed' for succeed node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for succeed node at depth '${e}'`);f(t,e),b(t.child,e+1)}function le(t,e){if(t.type!=="fail")throw new Error(`expected node type of 'fail' for fail node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for fail node at depth '${e}'`);f(t,e),b(t.child,e+1)}function ce(t,e){if(t.type!=="flip")throw new Error(`expected node type of 'flip' for flip node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for flip node at depth '${e}'`);f(t,e),b(t.child,e+1)}function pe(t,e){if(t.type!=="repeat")throw new Error(`expected node type of 'repeat' for repeat node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for repeat node at depth '${e}'`);if(typeof t.iterations<"u")if(Array.isArray(t.iterations)){let r=!!t.iterations.filter(o=>!y(o)).length;if(t.iterations.length!==2||r)throw new Error(`expected array containing two integer values for 'iterations' property if defined for repeat node at depth '${e}'`);if(t.iterations[0]<0||t.iterations[1]<0)throw new Error(`expected positive minimum and maximum iterations count for 'iterations' property if defined for repeat node at depth '${e}'`);if(t.iterations[0]>t.iterations[1])throw new Error(`expected minimum iterations count that does not exceed the maximum iterations count for 'iterations' property if defined for repeat node at depth '${e}'`)}else if(y(t.iterations)){if(t.iterations<0)throw new Error(`expected positive iterations count for 'iterations' property if defined for repeat node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'iterations' property if defined for repeat node at depth '${e}'`);f(t,e),b(t.child,e+1)}function fe(t,e){if(t.type!=="retry")throw new Error(`expected node type of 'retry' for retry node at depth '${e}'`);if(typeof t.child>"u")throw new Error(`expected property 'child' to be defined for retry node at depth '${e}'`);if(typeof t.attempts<"u")if(Array.isArray(t.attempts)){let r=!!t.attempts.filter(o=>!y(o)).length;if(t.attempts.length!==2||r)throw new Error(`expected array containing two integer values for 'attempts' property if defined for retry node at depth '${e}'`);if(t.attempts[0]<0||t.attempts[1]<0)throw new Error(`expected positive minimum and maximum attempts count for 'attempts' property if defined for retry node at depth '${e}'`);if(t.attempts[0]>t.attempts[1])throw new Error(`expected minimum attempts count that does not exceed the maximum attempts count for 'attempts' property if defined for retry node at depth '${e}'`)}else if(y(t.attempts)){if(t.attempts<0)throw new Error(`expected positive attempts count for 'attempts' property if defined for retry node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'attempts' property if defined for retry node at depth '${e}'`);f(t,e),b(t.child,e+1)}function he(t,e){if(t.type!=="branch")throw new Error(`expected node type of 'branch' for branch node at depth '${e}'`);if(typeof t.ref!="string"||t.ref.length===0)throw new Error(`expected non-empty string for 'ref' property for branch node at depth '${e}'`);["while","until"].forEach(r=>{if(typeof t[r]<"u")throw new Error(`guards should not be defined for branch nodes but guard '${r}' was defined for branch node at depth '${e}'`)}),["entry","exit","step"].forEach(r=>{if(typeof t[r]<"u")throw new Error(`callbacks should not be defined for branch nodes but callback '${r}' was defined for branch node at depth '${e}'`)})}function me(t,e){if(t.type!=="action")throw new Error(`expected node type of 'action' for action node at depth '${e}'`);if(typeof t.call!="string"||t.call.length===0)throw new Error(`expected non-empty string for 'call' property of action node at depth '${e}'`);if(typeof t.args<"u"&&!Array.isArray(t.args))throw new Error(`expected array for 'args' property if defined for action node at depth '${e}'`);f(t,e)}function ge(t,e){if(t.type!=="condition")throw new Error(`expected node type of 'condition' for condition node at depth '${e}'`);if(typeof t.call!="string"||t.call.length===0)throw new Error(`expected non-empty string for 'call' property of condition node at depth '${e}'`);if(typeof t.args<"u"&&!Array.isArray(t.args))throw new Error(`expected array for 'args' property if defined for condition node at depth '${e}'`);f(t,e)}function be(t,e){if(t.type!=="wait")throw new Error(`expected node type of 'wait' for wait node at depth '${e}'`);if(typeof t.duration<"u")if(Array.isArray(t.duration)){let r=!!t.duration.filter(o=>!y(o)).length;if(t.duration.length!==2||r)throw new Error(`expected array containing two integer values for 'duration' property if defined for wait node at depth '${e}'`);if(t.duration[0]<0||t.duration[1]<0)throw new Error(`expected positive minimum and maximum duration for 'duration' property if defined for wait node at depth '${e}'`);if(t.duration[0]>t.duration[1])throw new Error(`expected minimum duration value that does not exceed the maximum duration value for 'duration' property if defined for wait node at depth '${e}'`)}else if(y(t.duration)){if(t.duration<0)throw new Error(`expected positive duration value for 'duration' property if defined for wait node at depth '${e}'`)}else throw new Error(`expected integer value or array containing two integer values for 'duration' property if defined for wait node at depth '${e}'`);f(t,e)}function ye(t,e){if(t.type!=="sequence")throw new Error(`expected node type of 'sequence' for sequence node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for sequence node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function Ne(t,e){if(t.type!=="selector")throw new Error(`expected node type of 'selector' for selector node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for selector node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function we(t,e){if(t.type!=="parallel")throw new Error(`expected node type of 'parallel' for parallel node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for parallel node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function Ae(t,e){if(t.type!=="race")throw new Error(`expected node type of 'race' for race node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for race node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function Ee(t,e){if(t.type!=="all")throw new Error(`expected node type of 'all' for all node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for all node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function De(t,e){if(t.type!=="lotto")throw new Error(`expected node type of 'lotto' for lotto node at depth '${e}'`);if(!Array.isArray(t.children)||t.children.length===0)throw new Error(`expected non-empty 'children' array to be defined for lotto node at depth '${e}'`);if(typeof t.weights<"u"&&(!Array.isArray(t.weights)||t.weights.length!==t.children.length||t.weights.filter(r=>!y(r)).length||t.weights.filter(r=>r<0).length))throw new Error(`expected an array of positive integer weight values with a length matching the number of child nodes for 'weights' property if defined for lotto node at depth '${e}'`);f(t,e),t.children.forEach(r=>b(r,e+1))}function A(t){return{succeeded:!1,errorMessage:t}}var S=class extends Error{constructor(r){super("A guard path condition has failed");this.source=r}isSourceNode=r=>r===this.source};var T=class{constructor(e){this.nodes=e}evaluate=e=>{for(let r of this.nodes)for(let o of r.guards)if(!o.isSatisfied(e))throw new S(r.node)}};function xt(){var t=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}var E=class{constructor(e,r,o){this.type=e;this.options=o;this.uid=xt(),this.attributes={entry:r.find(({type:i})=>i==="entry"),step:r.find(({type:i})=>i==="step"),exit:r.find(({type:i})=>i==="exit"),while:r.find(({type:i})=>i==="while"),until:r.find(({type:i})=>i==="until")}}uid;attributes;_state="mistreevous.ready";_guardPath;getState=()=>this._state;setState=e=>{let r=this._state;this._state=e,r!==e&&this.onStateChanged(r)};getUid=()=>this.uid;getType=()=>this.type;getAttributes=()=>Object.values(this.attributes).filter(e=>!!e);setGuardPath=e=>this._guardPath=e;hasGuardPath=()=>!!this._guardPath;is(e){return this._state===e}reset(){this.setState("mistreevous.ready")}abort(e){!this.is("mistreevous.running")||(this.reset(),this.attributes.exit?.callAgentFunction(e,!1,!0))}update(e){if(!(this.is("mistreevous.succeeded")||this.is("mistreevous.failed")))try{this._guardPath.evaluate(e),this.is("mistreevous.ready")&&this.attributes.entry?.callAgentFunction(e),this.attributes.step?.callAgentFunction(e),this.onUpdate(e),(this.is("mistreevous.succeeded")||this.is("mistreevous.failed"))&&this.attributes.exit?.callAgentFunction(e,this.is("mistreevous.succeeded"),!1)}catch(r){if(r instanceof S&&r.isSourceNode(this))this.abort(e),this.setState("mistreevous.failed");else throw r}}getDetails(){return{id:this.uid,name:this.getName(),type:this.type,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),state:this._state}}onStateChanged(e){this.options.onNodeStateChange?.({id:this.uid,type:this.type,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:e,state:this._state})}};var h=class extends E{constructor(r,o,i,n){super(r,o,i);this.children=n}isLeafNode=()=>!1;getChildren=()=>this.children;reset=()=>{this.setState("mistreevous.ready"),this.children.forEach(r=>r.reset())};abort=r=>{!this.is("mistreevous.running")||(this.children.forEach(o=>o.abort(r)),this.reset(),this.attributes.exit?.callAgentFunction(r,!1,!0))};getDetails(){return{...super.getDetails(),children:this.children.map(r=>r.getDetails())}}};var L=class extends h{constructor(e,r,o){super("parallel",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.find(r=>r.is("mistreevous.failed"))){this.setState("mistreevous.failed");for(let r of this.children)r.getState()==="mistreevous.running"&&r.abort(e);return}if(this.children.every(r=>r.is("mistreevous.succeeded"))){this.setState("mistreevous.succeeded");return}this.setState("mistreevous.running")}getName=()=>"PARALLEL"};var O=class extends h{constructor(e,r,o){super("race",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.find(r=>r.is("mistreevous.succeeded"))){this.setState("mistreevous.succeeded");for(let r of this.children)r.getState()==="mistreevous.running"&&r.abort(e);return}if(this.children.every(r=>r.is("mistreevous.failed"))){this.setState("mistreevous.failed");return}this.setState("mistreevous.running")}getName=()=>"RACE"};var P=class extends h{constructor(e,r,o){super("all",e,r,o)}onUpdate(e){for(let r of this.children)(r.getState()==="mistreevous.ready"||r.getState()==="mistreevous.running")&&r.update(e);if(this.children.every(r=>r.is("mistreevous.succeeded")||r.is("mistreevous.failed"))){this.setState(this.children.find(r=>r.is("mistreevous.succeeded"))?"mistreevous.succeeded":"mistreevous.failed");return}this.setState("mistreevous.running")}getName=()=>"ALL"};var G=class extends h{constructor(r,o,i){super("selector",r,o,i);this.children=i}onUpdate(r){for(let o of this.children){if((o.getState()==="mistreevous.ready"||o.getState()==="mistreevous.running")&&o.update(r),o.getState()==="mistreevous.succeeded"){this.setState("mistreevous.succeeded");return}if(o.getState()==="mistreevous.failed")if(this.children.indexOf(o)===this.children.length-1){this.setState("mistreevous.failed");return}else continue;if(o.getState()==="mistreevous.running"){this.setState("mistreevous.running");return}throw new Error("child node was not in an expected state.")}}getName=()=>"SELECTOR"};var k=class extends h{constructor(r,o,i){super("sequence",r,o,i);this.children=i}onUpdate(r){for(let o of this.children){if((o.getState()==="mistreevous.ready"||o.getState()==="mistreevous.running")&&o.update(r),o.getState()==="mistreevous.succeeded")if(this.children.indexOf(o)===this.children.length-1){this.setState("mistreevous.succeeded");return}else continue;if(o.getState()==="mistreevous.failed"){this.setState("mistreevous.failed");return}if(o.getState()==="mistreevous.running"){this.setState("mistreevous.running");return}throw new Error("child node was not in an expected state.")}}getName=()=>"SEQUENCE"};var Ft=Bt($t());var B=class extends h{constructor(r,o,i,n){super("lotto",r,o,n);this.weights=i}selectedChild;onUpdate(r){if(this.is("mistreevous.ready")){let o=(0,Ft.default)({random:this.options.random,participants:this.children.map((i,n)=>[i,this.weights?.[n]||1])});this.selectedChild=o.draw()||void 0}if(!this.selectedChild)throw new Error("failed to update lotto node as it has no active child");(this.selectedChild.getState()==="mistreevous.ready"||this.selectedChild.getState()==="mistreevous.running")&&this.selectedChild.update(r),this.setState(this.selectedChild.getState())}getName=()=>this.weights?`LOTTO [${this.weights.join(",")}]`:"LOTTO"};var m=class extends E{constructor(r,o,i,n){super(r,o,i);this.child=n}isLeafNode=()=>!1;getChildren=()=>[this.child];reset=()=>{this.setState("mistreevous.ready"),this.child.reset()};abort=r=>{!this.is("mistreevous.running")||(this.child.abort(r),this.reset(),this.attributes.exit?.callAgentFunction(r,!1,!0))};getDetails(){return{...super.getDetails(),children:[this.child.getDetails()]}}};var _=class extends m{constructor(e,r,o){super("fail",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":case"mistreevous.failed":this.setState("mistreevous.failed");break;default:this.setState("mistreevous.ready")}}getName=()=>"FAIL"};var Y=class extends m{constructor(e,r,o){super("flip",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":this.setState("mistreevous.failed");break;case"mistreevous.failed":this.setState("mistreevous.succeeded");break;default:this.setState("mistreevous.ready")}}getName=()=>"FLIP"};var j=class extends m{constructor(r,o,i,n,a,s){super("repeat",r,o,s);this.iterations=i;this.iterationsMin=n;this.iterationsMax=a}targetIterationCount=null;currentIterationCount=0;onUpdate(r){if(this.is("mistreevous.ready")&&(this.child.reset(),this.currentIterationCount=0,this.setTargetIterationCount()),this.canIterate())if(this.setState("mistreevous.running"),this.child.getState()==="mistreevous.succeeded"&&this.child.reset(),this.child.update(r),this.child.getState()==="mistreevous.failed"){this.setState("mistreevous.failed");return}else this.child.getState()==="mistreevous.succeeded"&&(this.currentIterationCount+=1);else this.setState("mistreevous.succeeded")}getName=()=>this.iterations!==null?`REPEAT ${this.iterations}x`:this.iterationsMin!==null&&this.iterationsMax!==null?`REPEAT ${this.iterationsMin}x-${this.iterationsMax}x`:"REPEAT";reset=()=>{this.setState("mistreevous.ready"),this.currentIterationCount=0,this.child.reset()};canIterate=()=>this.targetIterationCount!==null?this.currentIterationCount<this.targetIterationCount:!0;setTargetIterationCount=()=>{if(this.iterations!==null)this.targetIterationCount=this.iterations;else if(this.iterationsMin!==null&&this.iterationsMax!==null){let r=typeof this.options.random=="function"?this.options.random:Math.random;this.targetIterationCount=Math.floor(r()*(this.iterationsMax-this.iterationsMin+1)+this.iterationsMin)}else this.targetIterationCount=null}};var q=class extends m{constructor(r,o,i,n,a,s){super("retry",r,o,s);this.attempts=i;this.attemptsMin=n;this.attemptsMax=a}targetAttemptCount=null;currentAttemptCount=0;onUpdate(r){if(this.is("mistreevous.ready")&&(this.child.reset(),this.currentAttemptCount=0,this.setTargetAttemptCount()),this.canAttempt())if(this.setState("mistreevous.running"),this.child.getState()==="mistreevous.failed"&&this.child.reset(),this.child.update(r),this.child.getState()==="mistreevous.succeeded"){this.setState("mistreevous.succeeded");return}else this.child.getState()==="mistreevous.failed"&&(this.currentAttemptCount+=1);else this.setState("mistreevous.failed")}getName=()=>this.attempts!==null?`RETRY ${this.attempts}x`:this.attemptsMin!==null&&this.attemptsMax!==null?`RETRY ${this.attemptsMin}x-${this.attemptsMax}x`:"RETRY";reset=()=>{this.setState("mistreevous.ready"),this.currentAttemptCount=0,this.child.reset()};canAttempt=()=>this.targetAttemptCount!==null?this.currentAttemptCount<this.targetAttemptCount:!0;setTargetAttemptCount=()=>{if(this.attempts!==null)this.targetAttemptCount=this.attempts;else if(this.attemptsMin!==null&&this.attemptsMax!==null){let r=typeof this.options.random=="function"?this.options.random:Math.random;this.targetAttemptCount=Math.floor(r()*(this.attemptsMax-this.attemptsMin+1)+this.attemptsMin)}else this.targetAttemptCount=null}};var W=class extends m{constructor(e,r,o){super("root",e,r,o)}onUpdate(e){(this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.setState(this.child.getState())}getName=()=>"ROOT"};var J=class extends m{constructor(e,r,o){super("succeed",e,r,o)}onUpdate(e){switch((this.child.getState()==="mistreevous.ready"||this.child.getState()==="mistreevous.running")&&this.child.update(e),this.child.getState()){case"mistreevous.running":this.setState("mistreevous.running");break;case"mistreevous.succeeded":case"mistreevous.failed":this.setState("mistreevous.succeeded");break;default:this.setState("mistreevous.ready")}}getName=()=>"SUCCEED"};var D=class extends E{isLeafNode=()=>!0};var V=class extends D{constructor(r,o,i,n){super("action",r,o);this.actionName=i;this.actionArguments=n}isUsingUpdatePromise=!1;updatePromiseResult=null;onUpdate(r){if(this.isUsingUpdatePromise){if(!this.updatePromiseResult)return;let{isResolved:n,value:a}=this.updatePromiseResult;if(n){if(a!=="mistreevous.succeeded"&&a!=="mistreevous.failed")throw new Error("action node promise resolved with an invalid value, expected a State.SUCCEEDED or State.FAILED value to be returned");this.setState(a);return}else throw new Error(`action function '${this.actionName}' promise rejected with '${a}'`)}let o=u.getFuncInvoker(r,this.actionName);if(o===null)throw new Error(`cannot update action node as the action '${this.actionName}' function is not defined on the agent and has not been registered`);let i;try{i=o(this.actionArguments)}catch(n){throw n instanceof Error?new Error(`action function '${this.actionName}' threw: ${n.stack}`):new Error(`action function '${this.actionName}' threw: ${n}`)}i instanceof Promise?(i.then(n=>{!this.isUsingUpdatePromise||(this.updatePromiseResult={isResolved:!0,value:n})},n=>{!this.isUsingUpdatePromise||(this.updatePromiseResult={isResolved:!1,value:n})}),this.setState("mistreevous.running"),this.isUsingUpdatePromise=!0):(this.validateUpdateResult(i),this.setState(i||"mistreevous.running"))}getName=()=>this.actionName;reset=()=>{this.setState("mistreevous.ready"),this.isUsingUpdatePromise=!1,this.updatePromiseResult=null};getDetails(){return{...super.getDetails(),args:this.actionArguments}}onStateChanged(r){this.options.onNodeStateChange?.({id:this.uid,type:this.getType(),args:this.actionArguments,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:r,state:this.getState()})}validateUpdateResult=r=>{switch(r){case"mistreevous.succeeded":case"mistreevous.failed":case"mistreevous.running":case void 0:return;default:throw new Error(`expected action function '${this.actionName}' to return an optional State.SUCCEEDED or State.FAILED value but returned '${r}'`)}}};var Q=class extends D{constructor(r,o,i,n){super("condition",r,o);this.conditionName=i;this.conditionArguments=n}onUpdate(r){let o=u.getFuncInvoker(r,this.conditionName);if(o===null)throw new Error(`cannot update condition node as the condition '${this.conditionName}' function is not defined on the agent and has not been registered`);let i;try{i=o(this.conditionArguments)}catch(n){throw n instanceof Error?new Error(`condition function '${this.conditionName}' threw: ${n.stack}`):new Error(`condition function '${this.conditionName}' threw: ${n}`)}if(typeof i!="boolean")throw new Error(`expected condition function '${this.conditionName}' to return a boolean but returned '${i}'`);this.setState(i?"mistreevous.succeeded":"mistreevous.failed")}getName=()=>this.conditionName;getDetails(){return{...super.getDetails(),args:this.conditionArguments}}onStateChanged(r){this.options.onNodeStateChange?.({id:this.uid,type:this.getType(),args:this.conditionArguments,while:this.attributes.while?.getDetails(),until:this.attributes.until?.getDetails(),entry:this.attributes.entry?.getDetails(),step:this.attributes.step?.getDetails(),exit:this.attributes.exit?.getDetails(),previousState:r,state:this.getState()})}};var H=class extends D{constructor(r,o,i,n,a){super("wait",r,o);this.duration=i;this.durationMin=n;this.durationMax=a}initialUpdateTime=0;totalDuration=null;waitedDuration=0;onUpdate(r){if(this.is("mistreevous.ready")){if(this.initialUpdateTime=new Date().getTime(),this.waitedDuration=0,this.duration!==null)this.totalDuration=this.duration;else if(this.durationMin!==null&&this.durationMax!==null){let o=typeof this.options.random=="function"?this.options.random:Math.random;this.totalDuration=Math.floor(o()*(this.durationMax-this.durationMin+1)+this.durationMin)}else this.totalDuration=null;this.setState("mistreevous.running")}if(this.totalDuration!==null){if(typeof this.options.getDeltaTime=="function"){let o=this.options.getDeltaTime();if(typeof o!="number"||isNaN(o))throw new Error("The delta time must be a valid number and not NaN.");this.waitedDuration+=o*1e3}else this.waitedDuration=new Date().getTime()-this.initialUpdateTime;this.waitedDuration>=this.totalDuration&&this.setState("mistreevous.succeeded")}}getName=()=>this.duration!==null?`WAIT ${this.duration}ms`:this.durationMin!==null&&this.durationMax!==null?`WAIT ${this.durationMin}ms-${this.durationMax}ms`:"WAIT"};var x=class{constructor(e,r){this.type=e;this.args=r}};var R=class extends x{constructor(r,o,i){super(r,o);this.condition=i}getCondition=()=>this.condition;isGuard=()=>!0;getDetails(){return{type:this.type,args:this.args,calls:this.getCondition()}}};var K=class extends R{constructor(e,r){super("while",r,e)}isSatisfied=e=>{let r=u.getFuncInvoker(e,this.getCondition());if(r===null)throw new Error(`cannot evaluate node guard as the condition '${this.getCondition()}' function is not defined on the agent and has not been registered`);let o;try{o=r(this.args)}catch(i){throw i instanceof Error?new Error(`guard condition function '${this.getCondition()}' threw: ${i.stack}`):new Error(`guard condition function '${this.getCondition()}' threw: ${i}`)}if(typeof o!="boolean")throw new Error(`expected guard condition function '${this.getCondition()}' to return a boolean but returned '${o}'`);return o}};var z=class extends R{constructor(e,r){super("until",r,e)}isSatisfied=e=>{let r=u.getFuncInvoker(e,this.getCondition());if(r===null)throw new Error(`cannot evaluate node guard as the condition '${this.getCondition()}' function is not defined on the agent and has not been registered`);let o;try{o=r(this.args)}catch(i){throw i instanceof Error?new Error(`guard condition function '${this.getCondition()}' threw: ${i.stack}`):new Error(`guard condition function '${this.getCondition()}' threw: ${i}`)}if(typeof o!="boolean")throw new Error(`expected guard condition function '${this.getCondition()}' to return a boolean but returned '${o}'`);return!o}};var v=class extends x{constructor(r,o,i){super(r,o);this.functionName=i}getFunctionName=()=>this.functionName;isGuard=()=>!1;getDetails(){return{type:this.type,args:this.args,calls:this.getFunctionName()}}};var X=class extends v{constructor(e,r){super("entry",r,e)}callAgentFunction=e=>{let r=u.getFuncInvoker(e,this.getFunctionName());if(r===null)throw new Error(`cannot call entry function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);r(this.args)}};var Z=class extends v{constructor(e,r){super("step",r,e)}callAgentFunction=e=>{let r=u.getFuncInvoker(e,this.getFunctionName());if(r===null)throw new Error(`cannot call step function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);r(this.args)}};var tt=class extends v{constructor(e,r){super("exit",r,e)}callAgentFunction=(e,r,o)=>{let i=u.getFuncInvoker(e,this.getFunctionName());if(i===null)throw new Error(`cannot call exit function '${this.getFunctionName()}' as is not defined on the agent and has not been registered`);i([{succeeded:r,aborted:o},...this.args])}};var ht=Symbol("__root__");function mt(t,e){let r=Fe(t);at([r[ht],...Object.values(r)],!0);let o=g(r[ht],r,e);return Te(o),o}function g(t,e,r){let o=$e(t);switch(t.type){case"root":return new W(o,r,g(t.child,e,r));case"repeat":let i=null,n=null,a=null;return Array.isArray(t.iterations)?(n=t.iterations[0],a=t.iterations[1]):y(t.iterations)&&(i=t.iterations),new j(o,r,i,n,a,g(t.child,e,r));case"retry":let s=null,d=null,U=null;return Array.isArray(t.attempts)?(d=t.attempts[0],U=t.attempts[1]):y(t.attempts)&&(s=t.attempts),new q(o,r,s,d,U,g(t.child,e,r));case"flip":return new Y(o,r,g(t.child,e,r));case"succeed":return new J(o,r,g(t.child,e,r));case"fail":return new _(o,r,g(t.child,e,r));case"sequence":return new k(o,r,t.children.map(N=>g(N,e,r)));case"selector":return new G(o,r,t.children.map(N=>g(N,e,r)));case"parallel":return new L(o,r,t.children.map(N=>g(N,e,r)));case"race":return new O(o,r,t.children.map(N=>g(N,e,r)));case"all":return new P(o,r,t.children.map(N=>g(N,e,r)));case"lotto":return new B(o,r,t.weights,t.children.map(N=>g(N,e,r)));case"branch":return g(e[t.ref].child,e,r);case"action":return new V(o,r,t.call,t.args||[]);case"condition":return new Q(o,r,t.call,t.args||[]);case"wait":let gt=null,bt=null,yt=null;return Array.isArray(t.duration)?(bt=t.duration[0],yt=t.duration[1]):y(t.duration)&&(gt=t.duration),new H(o,r,gt,bt,yt)}}function $e(t){let e=[];return t.while&&e.push(new K(t.while.call,t.while.args??[])),t.until&&e.push(new z(t.until.call,t.until.args??[])),t.entry&&e.push(new X(t.entry.call,t.entry.args??[])),t.step&&e.push(new Z(t.step.call,t.step.args??[])),t.exit&&e.push(new tt(t.exit.call,t.exit.args??[])),e}function Fe(t){let e={};for(let[r,o]of Object.entries(u.getSubtrees()))e[r]={...o,id:r};for(let r of t)e[r.id??ht]=r;return e}function Te(t){let e=[],r=(o,i)=>{o=o.concat(i),i.isLeafNode()?e.push(o):i.getChildren().forEach(n=>r(o,n))};r([],t),e.forEach(o=>{for(let i=0;i<o.length;i++){let n=o[i];if(n.hasGuardPath())continue;let a=new T(o.slice(0,i+1).map(s=>({node:s,guards:s.getAttributes().filter(d=>d.isGuard())})).filter(s=>s.guards.length>0));n.setGuardPath(a)}})}var lt=class{constructor(e,r,o={}){this.agent=r;this.options=o;if(ot(e))throw new Error("tree definition not defined");if(typeof r!="object"||r===null)throw new Error("the agent must be an object and not null");let{succeeded:i,errorMessage:n,json:a}=it(e);if(!i)throw new Error(`invalid definition: ${n}`);if(!a)throw new Error("expected json definition to be returned as part of successful definition validation response");try{this._rootNode=mt(a,o)}catch(s){throw new Error(`error building tree: ${s.message}`)}}_rootNode;isRunning(){return this._rootNode.getState()==="mistreevous.running"}getState(){return this._rootNode.getState()}step(){(this._rootNode.getState()==="mistreevous.succeeded"||this._rootNode.getState()==="mistreevous.failed")&&this._rootNode.reset();try{this._rootNode.update(this.agent)}catch(e){throw new Error(`error stepping tree: ${e.message}`)}}reset(){this._rootNode.reset()}getTreeNodeDetails(){return this._rootNode.getDetails()}static register(e,r){if(typeof r=="function"){u.setFunc(e,r);return}if(typeof r=="string"){let o;try{o=C(r)}catch(i){throw new Error(`error registering definition, invalid MDSL: ${i.message}`)}if(o.length!=1||typeof o[0].id<"u")throw new Error("error registering definition: expected a single unnamed root node");try{let{succeeded:i,errorMessage:n}=nt(o[0]);if(!i)throw new Error(n)}catch(i){throw new Error(`error registering definition: ${i.message}`)}u.setSubtree(e,o[0])}else if(typeof r=="object"&&!Array.isArray(r)){try{let{succeeded:o,errorMessage:i}=nt(r);if(!o)throw new Error(i)}catch(o){throw new Error(`error registering definition: ${o.message}`)}u.setSubtree(e,r)}else throw new Error("unexpected value, expected string mdsl definition, root node json definition or function")}static unregister(e){u.remove(e)}static unregisterAll(){u.empty()}};return _t(Le);})();
//# sourceMappingURL=mistreevous.min.js.map
